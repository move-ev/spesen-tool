// Prisma schema for Better Auth
// learn more: https://better-auth.com/docs/concepts/database

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

// NOTE: When using mysql or sqlserver, uncomment the //@db.Text annotations in model Account below
// Further reading:
// https://www.prisma.io/docs/reference/api-reference/prisma-schema-reference#string

datasource db {
  provider = "postgresql"
}

model Report {
  id          String       @id @default(cuid())
  tag         Int          @unique @default(autoincrement())
  title       String
  description String?
  status      ReportStatus @default(DRAFT)

  costUnitId String
  costUnit   CostUnit @relation(fields: [costUnitId], references: [id], onDelete: Cascade)

  owner   User   @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  ownerId String

  bankingDetailsId String
  bankingDetails   BankingDetails @relation(fields: [bankingDetailsId], references: [id], onDelete: Restrict)

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt     DateTime @default(now())
  lastUpdatedAt DateTime @updatedAt

  expenses Expense[]

  @@index([ownerId])
  @@index([status])
  @@index([costUnitId])
  @@index([bankingDetailsId])
  @@map("report")
}

enum ReportStatus {
  DRAFT
  PENDING_APPROVAL
  NEEDS_REVISION
  ACCEPTED
  REJECTED
}

model Expense {
  id          String      @id @default(cuid())
  description String?
  amount      Decimal
  startDate   DateTime
  endDate     DateTime
  type        ExpenseType
  meta        Json

  reportId    String
  report      Report       @relation(fields: [reportId], references: [id], onDelete: Cascade)
  attachments Attachment[]

  @@index([reportId])
  @@map("expense")
}

enum ExpenseType {
  RECEIPT
  TRAVEL
  FOOD
}

enum FileVisibility {
  PRIVATE // Default for expense receipts
  PUBLIC  // Organization logos, public assets
}

enum FileStatus {
  PENDING  // Upload URL generated but not confirmed
  UPLOADED // Successfully uploaded and verified
  FAILED   // Upload failed
  DELETED  // Soft-deleted (audit trail)
}

model Attachment {
  id  String @id @default(cuid())
  key String // S3 object key

  // Metadata
  originalName String?        // Original filename
  contentType  String?        // MIME type
  size         Int?           // File size in bytes
  visibility   FileVisibility @default(PRIVATE)
  status       FileStatus     @default(PENDING)

  // Audit trail
  uploadedById String?
  uploadedBy   User?   @relation("UploadedAttachments", fields: [uploadedById], references: [id], onDelete: Restrict)
  uploadedAt   DateTime @default(now())

  // Soft delete
  deletedAt   DateTime?
  deletedById String?
  deletedBy   User?     @relation("DeletedAttachments", fields: [deletedById], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  expenseId String? // Nullable for org logos
  expense   Expense? @relation(fields: [expenseId], references: [id], onDelete: Cascade)

  organizationId String?       // For org-level files (logos)
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([key])
  @@index([expenseId])
  @@index([organizationId])
  @@index([uploadedById])
  @@index([status])
  @@map("attachment")
}

model User {
  id            String    @id
  name          String //@db.Text - Required by better-auth, we provide fallback in mapProfileToUser
  email         String
  emailVerified Boolean   @default(false) // Required by better-auth as boolean, not DateTime
  image         String? //@db.Text
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @default(now()) @updatedAt
  sessions      Session[]
  accounts      Account[]

  ownReports Report[]

  // Role required by better-auth admin plugin
  role String @default("user")

  // Banning fields required by better-auth admin plugin
  banned     Boolean?  @default(false)
  banReason  String?
  banExpires DateTime?

  preferences Preferences?

  bankingDetails BankingDetails[]

  members     Member[]
  invitations Invitation[]

  uploadedAttachments Attachment[] @relation("UploadedAttachments")
  deletedAttachments  Attachment[] @relation("DeletedAttachments")

  @@unique([email])
  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String? //@db.Text
  userAgent String? //@db.Text
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  impersonatedBy String?

  activeOrganizationId String?

  @@unique([token])
  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String //@db.Text
  providerId            String //@db.Text
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String? //@db.Text
  refreshToken          String? //@db.Text
  idToken               String? //@db.Text
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String? //@db.Text
  password              String? //@db.Text
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String //@db.Text
  value      String //@db.Text
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  @@index([identifier])
  @@map("verification")
}

model Preferences {
  id            String                 @id @default(cuid())
  userId        String                 @unique
  user          User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  notifications NotificationPreference @default(ALL)

  @@map("preferences")
}

enum NotificationPreference {
  ALL
  STATUS_CHANGES
  NONE
}

model Settings {
  id              String   @id @default("singleton")
  kilometerRate   Decimal  @default(0.30) // Rate per kilometer in EUR
  reviewerEmail   String? // Email of the global reviewer
  costUnitInfoUrl String?  @map("accountingUnitPdfUrl") // PDF URL for cost unit information
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  dailyFoodAllowance Decimal @default(0.00)
  breakfastDeduction Decimal @default(0.00)
  lunchDeduction     Decimal @default(0.00)
  dinnerDeduction    Decimal @default(0.00)

  @@map("settings")
}

model CostUnitGroup {
  id        String     @id @default(cuid())
  title     String
  costUnits CostUnit[]

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@unique([title])
  @@map("cost_unit_group")
}

model CostUnit {
  id       String   @id @default(cuid())
  tag      String
  title    String
  examples String[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  costUnitGroupId String?
  costUnitGroup   CostUnitGroup? @relation(fields: [costUnitGroupId], references: [id], onDelete: Cascade)

  reports Report[]

  @@index([tag])
  @@map("cost_unit")
}

model BankingDetails {
  id    String @id @default(cuid())
  // Used for displaying the banking details in the UI without exposing the iban
  title String

  iban     String
  fullName String

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  reports Report[]

  @@index([userId])
  @@map("banking_details")
}

model Organization {
  id          String       @id
  name        String
  slug        String
  logo        String?
  createdAt   DateTime
  metadata    String?
  members     Member[]
  invitations Invitation[]

  settingsId          String?
  settings            OrganizationSettings?
  organizationDomains OrganizationDomain[]
  reports             Report[]
  attachments         Attachment[]

  @@unique([slug])
  @@map("organization")
}

model Member {
  id             String       @id
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  role           String       @default("member")
  createdAt      DateTime

  @@index([organizationId])
  @@index([userId])
  @@map("member")
}

model Invitation {
  id             String       @id
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  email          String
  role           String?
  status         String       @default("pending")
  expiresAt      DateTime
  createdAt      DateTime     @default(now())
  inviterId      String
  user           User         @relation(fields: [inviterId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([email])
  @@map("invitation")
}

model OrganizationSettings {
  id String @id @default(cuid())

  organizationId String        @unique
  organization   Organization? @relation(fields: [organizationId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@map("organization_settings")
}

model OrganizationDomain {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  domain         String       @unique
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([organizationId])
  @@map("organization_domain")
}
